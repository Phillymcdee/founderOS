generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  accounts               Account[]
  subscriptions          Subscription[]
  metricsSnapshots       MetricsSnapshot[]
  founderSummaries       FounderSummary[]
  events                 Event[]
  ideas                  Idea[]
  ideaExperiments        IdeaExperiment[]
  ideaSignals            IdeaSignal[]
  businessIntentConfig   BusinessIntentConfig?
  ideaIntentConfig       IdeaIntentConfig?
  productEmailMessages   ProductEmailMessage[]
  productTransactions    ProductTransaction[]
  productRecommendations ProductRecommendation[]
  archetypeInstances     ArchetypeInstance[]
  archetypeScores        ArchetypeScore[]
  archetypeDemandTests   ArchetypeDemandTest[]
}

model Account {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())

  tenant                 Tenant                  @relation(fields: [tenantId], references: [id])
  subscriptions          Subscription[]
  productEmailMessages   ProductEmailMessage[]
  productTransactions    ProductTransaction[]
  productRecommendations ProductRecommendation[]
}

model Subscription {
  id          String    @id @default(cuid())
  tenantId    String
  accountId   String
  mrr         Int
  plan        String
  status      String
  startedAt   DateTime
  cancelledAt DateTime?
  createdAt   DateTime  @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  account Account @relation(fields: [accountId], references: [id])
}

model MetricsSnapshot {
  id              String   @id @default(cuid())
  tenantId        String
  periodEnd       DateTime
  mrr             Int
  newMrr          Int
  churnedMrr      Int
  activeCustomers Int
  runwayMonths    Int?
  createdAt       DateTime @default(now())

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  founderSummaries FounderSummary[]
}

model FounderSummary {
  id                 String   @id @default(cuid())
  tenantId           String
  metricsSnapshotId  String
  periodEnd          DateTime
  narrative          String
  recommendedActions String
  state              String // DRAFT, PENDING_APPROVAL, PUBLISHED, ARCHIVED
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  tenant          Tenant          @relation(fields: [tenantId], references: [id])
  metricsSnapshot MetricsSnapshot @relation(fields: [metricsSnapshotId], references: [id])
}

model Event {
  id              String   @id @default(cuid())
  tenantId        String
  type            String
  payload         Json
  flowInstanceId  String?
  primaryEntityId String?
  createdAt       DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model Idea {
  id               String   @id @default(cuid())
  tenantId         String
  title            String
  description      String
  transformation   String?
  icpDescription   String?
  arpuEstimate     Int?
  regulatedConcern Boolean  @default(false)
  manualWorkHeavy  Boolean  @default(false)
  founderFitSignal Boolean  @default(true)
  autoGenerated    Boolean  @default(false)
  sourceSignalIds  String[] @default([])

  passesMarket     Boolean @default(false)
  passesRegulation Boolean @default(false)
  passesAgentFit   Boolean @default(false)
  passesFounderFit Boolean @default(false)

  painFrequencyScore Int? // 1-3
  agentLeverageScore Int?
  dataSurfaceScore   Int?
  repeatabilityScore Int?
  totalScore         Int?

  notesTrustRisk        String?
  notesGtm              String?
  notesFounderAdvantage String?

  state     String   @default("BACKLOG")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant             Tenant              @relation(fields: [tenantId], references: [id])
  experiments        IdeaExperiment[]
  archetypeInstances ArchetypeInstance[]
}

model IdeaExperiment {
  id          String   @id @default(cuid())
  tenantId    String
  ideaId      String
  type        String // SIGNAL, WORKFLOW, AGENT_OWNERSHIP
  description String
  result      String? // PENDING, PASSED, FAILED, INCONCLUSIVE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  idea   Idea   @relation(fields: [ideaId], references: [id])
}

model IdeaSignal {
  id        String   @id @default(cuid())
  tenantId  String
  source    String
  content   String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model ProductEmailMessage {
  id                 String    @id @default(cuid())
  tenantId           String
  accountId          String
  vendorName         String
  subject            String
  amountCents        Int
  currency           String    @default("USD")
  invoiceDate        DateTime
  servicePeriodStart DateTime?
  servicePeriodEnd   DateTime?
  status             String    @default("INGESTED") // INGESTED, PARSED
  ingestedAt         DateTime  @default(now())
  parsedAt           DateTime?
  rawPayload         Json?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  account     Account             @relation(fields: [accountId], references: [id])
  transaction ProductTransaction? @relation("EmailMessageTransaction")
}

model ProductTransaction {
  id             String   @id @default(cuid())
  tenantId       String
  accountId      String
  vendorName     String
  amountCents    Int
  currency       String   @default("USD")
  periodStart    DateTime
  periodEnd      DateTime
  status         String   @default("ACTIVE")
  isRecurring    Boolean  @default(true)
  emailMessageId String?  @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant          Tenant                  @relation(fields: [tenantId], references: [id])
  account         Account                 @relation(fields: [accountId], references: [id])
  emailMessage    ProductEmailMessage?    @relation("EmailMessageTransaction", fields: [emailMessageId], references: [id])
  recommendations ProductRecommendation[]
}

model ProductRecommendation {
  id                    String   @id @default(cuid())
  tenantId              String
  accountId             String
  vendorName            String
  type                  String // HIGH_SPEND, UPCOMING_RENEWAL, etc.
  summary               String
  potentialSavingsCents Int?
  status                String   @default("PENDING_REVIEW")
  periodStart           DateTime
  periodEnd             DateTime
  transactionId         String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  account     Account             @relation(fields: [accountId], references: [id])
  transaction ProductTransaction? @relation(fields: [transactionId], references: [id])

  @@unique([tenantId, vendorName, type, periodStart, periodEnd])
}

model ArchetypeInstance {
  id                    String    @id @default(cuid())
  tenantId              String
  patternKey            String
  icpKey                String    @default("default")
  label                 String
  summary               String?
  icpDescription        String?
  dataSurfaces          String[]  @default([])
  targetArpuLow         Int?
  targetArpuHigh        Int?
  intentVersion         String?
  sourceSignalIds       String[]  @default([])
  linkedIdeaId          String?
  state                 String    @default("BACKLOG")
  monetizationScore     Int?
  dataSurfaceScore      Int?
  agentLeverageScore    Int?
  reachabilityScore     Int?
  osFitScore            Int?
  totalScore            Int?
  scoreUpdatedAt        DateTime?
  lastDemandTestAt      DateTime?
  lastDemandTestVerdict String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  tenant      Tenant                @relation(fields: [tenantId], references: [id])
  linkedIdea  Idea?                 @relation(fields: [linkedIdeaId], references: [id])
  scores      ArchetypeScore[]
  demandTests ArchetypeDemandTest[]

  @@unique([tenantId, patternKey, icpKey])
}

model ArchetypeScore {
  id                  String   @id @default(cuid())
  tenantId            String
  archetypeInstanceId String
  monetizationScore   Int
  dataSurfaceScore    Int
  agentLeverageScore  Int
  reachabilityScore   Int
  osFitScore          Int
  totalScore          Int
  scoreSource         String   @default("HEURISTIC")
  explanation         Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  archetypeInstance ArchetypeInstance @relation(fields: [archetypeInstanceId], references: [id])
}

model ArchetypeDemandTest {
  id                  String   @id @default(cuid())
  tenantId            String
  archetypeInstanceId String
  status              String   @default("PENDING")
  outreachCount       Int      @default(0)
  positiveResponses   Int      @default(0)
  meetingsBooked      Int      @default(0)
  willingnessSignals  Int      @default(0)
  verdict             String?
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  archetypeInstance ArchetypeInstance @relation(fields: [archetypeInstanceId], references: [id])
}

model BusinessIntentConfig {
  id                  String   @id @default(cuid())
  tenantId            String   @unique
  targetMrr           Int
  acceptableChurnRate Float
  alertChurnRate      Float
  alertRunwayMonths   Int?
  summaryTone         String
  summaryMaxActions   Int
  maxActiveProducts   Int?
  weeklyFounderHours  Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model IdeaIntentConfig {
  id                    String   @id @default(cuid())
  tenantId              String   @unique
  arpuFloor             Int
  excludedDomains       String[]
  founderStrengths      String[]
  agentFitKeywords      String[]
  minScoreForExperiment Int
  maxActiveExperiments  Int?
  maxExperimentingIdeas Int?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}
